---
title: HTTP系列 - 透过TCP/IP看HTTP
date: 2018-04-11
tags:
- HTTP
category:
- 计算机网络
abstract: HTTP与TCP/IP
---

## HTTP与TCP/IP
HTTP协议是构建在TCP/IP协议之上的，是TCP/IP协议的一个子集。

### TCP/IP协议族
- TCP/IP协议其实是一系列与互联网相关联的协议集合起来的的总称
- 分层管理是TCP/IP协议的重要特征


### TCP/IP协议族分层
TCP/IP协议族是由一个四层协议组成的系统，分别为：**应用层**、**传输层**、**网络层**和**数据链路层**。
![GyCbNR.jpg](https://s1.ax1x.com/2020/04/06/GyCbNR.jpg)

**应用层**：
- 应用层一遍是我们编写的应用程序，决定了像用户提供的应用服务。应用层可以通过系统调用与传输层进行通信。
如：FTP、DNS、HTTP等。

**传输层**：
- 传输层通过系统调用向应用层提供处于网络连接中的两台计算机之间的数据传输功能(包含两个性质不同的协议：TCP和UDP协议)。
- MAC地址和IP地址，我们已经可以在互联网上任意两台主机上建立通信。但是怎么区分不同应用发送的消息呢？通过“端口”（port）。TCP和UDP和数据包的 **"标头"定义了发出端口和接收端口**。

**网络层（网络互连层）**：
- 网路层用来处理在网络上流动的IP数据包，IP数据包是网络传输的最小数据单位。规定了通过**IP地址**到达对方计算机，并把数据包传输给对方。
- IP数据包也分为"标头"和"数据"两个部分。**"标头"部分主要包括版本、长度、IP地址等信息**，"数据"部分则是IP数据包的具体内容。

**数据链路层**：
- 链路层用来处理连接网络的硬件部分，包括控制操作系统、硬件设备驱动、NIC（Network Interface Card， 网络适配器）以及光纤等屋里可见部分。硬件上的范畴均在链路层的作用范围之内。这一层数据根据网卡的MAC地址找到数据接受方，但是单纯靠MAC地址发送数据是有问题的。
- 如果两台设备同属一个子网，那通过MAC地址传输数据没有问题（通过广播方式），但是如果是不同子网，广播方式是不起作用的。因此，必须找到一种方法，能够区分哪些MAC地址属于同一个子网络，哪些不是。如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。**MAC地址本身无法做到区分子网。它只与厂商有关，与所处网络无关**。
- 上述情况下，网络层诞生了。它的作用是引进一套新的地址(IP地址)，使得我们能够区分不同的计算机是否属于同一个子网络。
- **网络地址帮助我们确定计算机所在的子网络**，**MAC地址则将数据包送到该子网络中的目标网卡**。因此，从逻辑上可以推断，必定是先处理网络地址，然后再处理MAC地址。
---

### 传输层-TCP的三次握手
![GsXk9g.jpg](https://s1.ax1x.com/2020/04/06/GsXk9g.jpg)
- 第一次握手：客户端发送带有SYN标志的连接请求报文段，
  然后进入**SYN_SEND**状态，等待服务端的确认。
- 第二次握手：服务端接收到到客户端的SYN报文段后，需要发送ACK信息对这个SYN报文段
  进行确认。同时还要发送自己的SYN请求信息。服务端会将上述信息放到一个报文段
  （**SYN + ACK 报文段**）中，一并发送给客户端，此次服务端将会进入**SYN_RECV**状态
- 第三次握手：客户端接收到服务端的SYN+ACK报文段后，会像服务端发送ACK确认报文段，这个   报文段发送完毕后，客户端和服务端都进入**ESTABLISHED**状态，完成TCP三次握手。

### 为什么要进行三次握手？
- 每次的握手都能确认对方的发送和自己的接收是正常的。但是想要建立一个连接，至少需要三次握手。因为两次握手不足以让客户端和服务端确认自己和对方的发送和接收是否都正常。

### DNS域名解析
- DNS提供**域名到IP地址之间的解析服务**。
- DNS解析流程（待查）：
    - 先在本地的hosts文件中查找有没有与域名映射的IP地址。如果有，直接访问。如果没有到第二步；
    - 查找本地DNS缓存。如果有，直接访问。如果没有到第三步；
    - 使用TCP/IP参数配置中的本地DNS服务器

### HTTP请求简图
![Gy8eMD.jpg](https://s1.ax1x.com/2020/04/06/Gy8eMD.jpg)
上面这张图作为HTTP请求的一个简图，大致描绘了浏览器从发起请求到收到数据的过程。

![Gy8ReJ.jpg](https://s1.ax1x.com/2020/04/06/Gy8ReJ.jpg)
客户端发起HTTP请求，先建立TCP连接，然后在TCP连接基础上发起HTTP请求。

---

### 工具（wireshark + chrome）
可以使用wireshark抓取浏览器的访问信息，下面是一张访问某网站的截图。可以清楚的看到传输层上TCP连接三次握手的请求：
![GyNi3q.jpg](https://s1.ax1x.com/2020/04/06/GyNi3q.jpg)
